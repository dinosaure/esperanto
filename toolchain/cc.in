#!/bin/sh
# Copyright (c) 2015-2021 Solo5 Contributors
# Copyright (c) 2021 Romain Calascibetta
#
# This file is part of Esperanto, a build-once run-anywhere toolchain
#
# Permission to use, copy, modify, and/or distribute this software
# for any purpose with or without fee is hereby granted, provided
# that the above copyright notice and this permission notice appear
# in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
# WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
# AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR
# CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS
# OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
# CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

# @@CONFIG_TARGET_TRIPLE@@-cc: Cosmopolitan wrapper for 'cc'.
# Generated by configure.sh at build time.
#
# Passes through to @@CONFIG_TARGET_CC@ for actual work. Defines all flags
# required for correct operation when building C code intended for inclusion in
# a Cosmopolitan artifact.
#
# Provides a '-z cosmopolitan-support-vector=bits' option which allows the user
# to choose which system he/she wants to support:
# - GNU/Systemd    (SUPPORT |= 0b0000001)
# - Bare Metal     (SUPPORT |= 0b0000010)
# - Windows        (SUPPORT |= 0b0000100)
# - XNU's Not Unix (SUPPORT |= 0b0001000)
# - OpenBSD        (SUPPORT |= 0b0010000)
# - FreeBSD        (SUPPORT |= 0b0100000)
# - NetBSD         (SUPPORT |= 0b1000000)
# ABI defaults to '0b1111111' to support all systems.

prog="$(basename $0)"
I="$(dirname $0)/../include/@@CONFIG_TARGET_TRIPLE@@"
[ ! -d "${I}" ] && echo "$prog: Could not determine include path" 1>&2 && exit 1
L="$(dirname $0)/../lib/@@CONFIG_TARGET_TRIPLE@@"
[ ! -d "${L}" ] && echo "$prog: Could not determine library path" 1>&2 && exit 1
# we can't really tell if 'cc' is called with no input, but work around the
# most obvious cases and stop them from "succeeding" and producing an "a.out"
[ "$#" -lt 1 ] && \
    echo "$prog: No input files. Compilation terminated." 1>&1 && exit 1
[ "$#" -eq 1 -a "$1" = "-v" ] && exec @@CONFIG_TARGET_CC@@ "$@"
# default to cc as linker, unless we see args to the contrary
M=link
# cc as linker with no -z cosmopolitan-support-vector= defaults to 0b1111111
B=0b1111111
Z=
S=
for arg do
    shift
    if [ -n "${Z}" ]; then
        # handle -z linker-arg
        Z=
        case "$arg" in
            cosmopolitan-support-vector=*)
                B="${arg##*=}"
                continue
                ;;
	    caml-startup)
		S=set
		continue
		;;
            *)
                set -- "$@" "-z" "$arg"
                continue
                ;;
        esac
    fi

    case "$arg" in
        -c|-S|-E)
            M=compile
            ;;
        -z)
            if [ -z "${Z}" ]; then
                Z=1
                continue
            fi
    esac
    set -- "$@" "$arg"
done
case ${M} in
    compile)
        [ -n "${B}" ] && B="-DSUPPORT_VECTOR=${B}"
        [ -n "${__V}" ] && set -x
        exec @@CONFIG_TARGET_CC@@ \
            @@CONFIG_TARGET_CC_CFLAGS@@ \
	    -g -Os -nostdlib -nostdinc \
	    -fno-pie -no-pie -mno-red-zone -fno-omit-frame-pointer -pg -mnop-mcount \
	    -I ${I} \
	    ${B} \
	    "$@" \
        ;;
    link)
        [ -n "${B}" ] && B="-DSUPPORT_VECTOR=${B}"
        [ -n "${S}" ] && S="${L}/startup.o"
        [ -n "${__V}" ] && set -x
        exec @@CONFIG_TARGET_CC@@ \
            @@CONFIG_TARGET_CC_CFLAGS@@ \
	    -g -Os -static -nostdlib -nostdinc \
	    -fno-pie -no-pie -mno-red-zone -fno-omit-frame-pointer -pg -mnop-mcount \
            @@CONFIG_TARGET_CC_LDFLAGS@@ ${S} ${B} \
            "$@" \
            -fuse-ld=bfd -Wl,-T,${L}/ape.lds \
	    -I ${I} \
	    ${L}/crt.o ${L}/ape.o ${L}/cosmopolitan.a
        ;;
esac
