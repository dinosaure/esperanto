#!/bin/sh
# Copyright (c) 2015-2021 Solo5 Contributors
# Copyright (c) 2021 Romain Calascibetta
#
# This file is part of Esperanto, a build-once run-anywhere toolchain
#
# Permission to use, copy, modify, and/or distribute this software
# for any purpose with or without fee is hereby granted, provided
# that the above copyright notice and this permission notice appear
# in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
# WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
# AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR
# CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS
# OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
# CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

# @@CONFIG_TARGET_TRIPLE@@-ld: Cosmopolitan wrapper for 'ld'.
# Generated by configure.sh at build time.
#
# Passes through to @@CONFIG_TARGET_LD@ for actual work. Defines all flags
# required for correct operation when linking code intended for inclusion in a
# a Cosmopolitan artifact.
#
# Provides a '-z cosmopolitan-support-vector=bits' option which allows the user
# to choose which system he/she wants to support:
# - GNU/Systemd    (SUPPORT |= 0b0000001)
# - Bare Metal     (SUPPORT |= 0b0000010)
# - Windows        (SUPPORT |= 0b0000100)
# - XNU's Not Unix (SUPPORT |= 0b0001000)
# - OpenBSD        (SUPPORT |= 0b0010000)
# - FreeBSD        (SUPPORT |= 0b0100000)
# - NetBSD         (SUPPORT |= 0b1000000)
# ABI defaults to '0b1111111' to support all systems.
#
# We introspect -g option and if we want to compile an assembler code. If -g
# if already set, we don't add it and if we want to compile an assembler code
# (a *.s file), we don't even add it (for binutils.2.34, it seems that a call
# to GCC with -g leads to an error "file number 1 already allocated" because
# OCaml emits something on this table, GCC wants to emit something on this
# table and [as] wants to emit something too... - the error disappears with
# binutils.2.36).

L="$(dirname $0)/../lib/@@CONFIG_TARGET_TRIPLE@@"
[ ! -d "${L}" ] && echo "$0: Could not determine library path" 1>&2 && exit 1
# ld accepts -z cosmopolitan-support-vector=, but does not provide a default
# support, this is intentional
B=
Z=
S=
G=
S=
WITHUNIX=
for arg do
    shift
    if [ -n "${Z}" ]; then
        # handle -z linker-arg
        Z=
        case "$arg" in
            cosmopolitan-support-vector=*)
                B="${arg##*=}"
                continue
                ;;
	    caml-startup)
		S=set
		continue
		;;
            *)
                set -- "$@" "-z" "$arg"
                continue
                ;;
        esac
    fi

    case "$arg" in
	-g)
	    G=set
        -z)
            if [ -z "${Z}" ]; then
                Z=1
                continue
            fi
            ;;
    esac

    [ "${arg##*.}" = "s" ] && A=set
    [ "${arg}" = "-lunix" ] && WITH_UNIX=set

    set -- "$@" "$arg"
done
[ -n "${B}" ] && B="-DSUPPORT_VECTOR=${B}"
[ -n "${S}" ] && S="${L}/startup.o"
[ -z "${G}" -a -z "${A}" ] && G="-g" || G=
[ -n "${WITH_UNIX}" ]  && WITH_UNIX="${L}/startup_unix.o" || WITH_UNIX="${L}/fake_unix.o"
exec @@CONFIG_TARGET_LD@@ \
    ${G} -static -nostdlib \
    @@CONFIG_TARGET_LD_LDFLAGS@@ ${S} ${B} "$@" \
    -fuse-ld=bfd -T ${L}/ape.lds \
    ${WITH_UNIX} ${S} -L ${L} ${L}/crt.o ${L}/ape.o ${L}cosmopolitan.a
